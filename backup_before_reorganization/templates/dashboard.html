{% extends "base.html" %}

{% block title %}Dashboard - AlexAI Agile Project Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600">Welcome to AlexAI Agile Project Management</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="scanWorkspace()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-sync-alt mr-2"></i>Scan Workspace
            </button>
            <button onclick="showCreateProjectModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-plus mr-2"></i>New Project
            </button>
        </div>
    </div>

    <!-- Multi-Agent Insights -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-users mr-2 text-blue-600"></i>
            Multi-Agent Insights
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="agent-picard rounded-lg p-4 text-white">
                <div class="flex items-center mb-2">
                    <i class="fas fa-crown mr-2"></i>
                    <span class="font-semibold">Captain Picard</span>
                </div>
                <p class="text-sm opacity-90">Strategic Leadership</p>
            </div>
            <div class="agent-troi rounded-lg p-4 text-white">
                <div class="flex items-center mb-2">
                    <i class="fas fa-heart mr-2"></i>
                    <span class="font-semibold">Counselor Troi</span>
                </div>
                <p class="text-sm opacity-90">UX & Morale</p>
            </div>
            <div class="agent-spock rounded-lg p-4 text-white">
                <div class="flex items-center mb-2">
                    <i class="fas fa-brain mr-2"></i>
                    <span class="font-semibold">Mr. Spock</span>
                </div>
                <p class="text-sm opacity-90">Logic & Time Management</p>
            </div>
            <div class="agent-data rounded-lg p-4 text-white">
                <div class="flex items-center mb-2">
                    <i class="fas fa-microchip mr-2"></i>
                    <span class="font-semibold">Lt. Commander Data</span>
                </div>
                <p class="text-sm opacity-90">UI Systems</p>
            </div>
            <div class="agent-scott rounded-lg p-4 text-white">
                <div class="flex items-center mb-2">
                    <i class="fas fa-cogs mr-2"></i>
                    <span class="font-semibold">Chief Engineer Scott</span>
                </div>
                <p class="text-sm opacity-90">Infrastructure</p>
            </div>
        </div>
        <div class="mt-4 space-x-3">
            <button onclick="getAgentInsights()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-lightbulb mr-2"></i>Get AI Insights
            </button>
            <button onclick="createMockData()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-database mr-2"></i>Create Mock Data
            </button>
        </div>
    </div>

    <!-- Project Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Active Projects -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-project-diagram mr-2 text-blue-600"></i>
                Active Missions
            </h3>
            <div class="space-y-3">
                {% for project in projects %}
                <div class="border rounded-lg p-3 card-hover hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">{{ project.name }}</h4>
                            <p class="text-sm text-gray-600">{{ project.project_type.value }}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                            {{ project.status }}
                        </span>
                    </div>
                    <div class="mt-2">
                        <a href="{{ url_for('project_detail', project_id=project.id) }}" 
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            View Details <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Tasks -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-tasks mr-2 text-green-600"></i>
                Recent Tasks
            </h3>
            <div id="recentTasks" class="space-y-3">
                <p class="text-gray-500 text-sm">Loading tasks...</p>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-purple-600"></i>
                Mission Statistics
            </h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Total Missions</span>
                    <span class="font-semibold text-blue-600">{{ projects|length }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Active Tasks</span>
                    <span class="font-semibold text-green-600" id="activeTasksCount">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Completed Today</span>
                    <span class="font-semibold text-purple-600" id="completedToday">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Crew Efficiency</span>
                    <span class="font-semibold text-orange-600" id="crewEfficiency">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Crew Activities & System Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Crew Activities -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-users mr-2 text-indigo-600"></i>
                Crew Activities
            </h3>
            <div id="crewActivities" class="space-y-3">
                <div class="border rounded-lg p-3 bg-blue-50">
                    <div class="flex items-center">
                        <i class="fas fa-crown mr-2 text-blue-600"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Captain Picard</p>
                            <p class="text-xs text-gray-600">Strategic review of Borg threat analysis</p>
                        </div>
                    </div>
                </div>
                <div class="border rounded-lg p-3 bg-green-50">
                    <div class="flex items-center">
                        <i class="fas fa-heart mr-2 text-green-600"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Counselor Troi</p>
                            <p class="text-xs text-gray-600">Team morale assessment completed</p>
                        </div>
                    </div>
                </div>
                <div class="border rounded-lg p-3 bg-yellow-50">
                    <div class="flex items-center">
                        <i class="fas fa-brain mr-2 text-yellow-600"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Mr. Spock</p>
                            <p class="text-xs text-gray-600">Logical analysis of quantum communication</p>
                        </div>
                    </div>
                </div>
                <div class="border rounded-lg p-3 bg-purple-50">
                    <div class="flex items-center">
                        <i class="fas fa-microchip mr-2 text-purple-600"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Lt. Commander Data</p>
                            <p class="text-xs text-gray-600">UI system optimization in progress</p>
                        </div>
                    </div>
                </div>
                <div class="border rounded-lg p-3 bg-pink-50">
                    <div class="flex items-center">
                        <i class="fas fa-cogs mr-2 text-pink-600"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Chief Engineer Scott</p>
                            <p class="text-xs text-gray-600">Infrastructure deployment completed</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-server mr-2 text-red-600"></i>
                Enterprise Systems Status
            </h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Warp Core</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Operational</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Shield Systems</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Operational</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Life Support</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Operational</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Holodeck Systems</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Maintenance</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Medical Bay</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Operational</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Security Protocols</span>
                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Updating</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Insights Panel -->
    <div id="agentInsights" class="hidden bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>
            AI Agent Insights
        </h3>
        <div id="insightsContent" class="space-y-4">
            <!-- Insights will be populated here -->
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div id="createProjectModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Create New Project</h3>
            <form id="createProjectForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Project Name</label>
                    <input type="text" id="projectName" required 
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                    <textarea id="projectDescription" rows="3"
                              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Project Type</label>
                    <select id="projectType" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="nextjs">Next.js</option>
                        <option value="react_native">React Native</option>
                        <option value="terraform">Terraform</option>
                        <option value="python">Python</option>
                        <option value="nodejs">Node.js</option>
                        <option value="amplify">AWS Amplify</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideCreateProjectModal()" 
                            class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Create Project
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
        <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
        <p class="text-white text-center mt-4">Processing...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Loading spinner functions
    function showLoadingSpinner() {
        document.getElementById('loadingSpinner').classList.remove('hidden');
    }

    function hideLoadingSpinner() {
        document.getElementById('loadingSpinner').classList.add('hidden');
    }

    // Load recent tasks on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentTasks();
        loadQuickStats();
    });

    function loadRecentTasks() {
        fetch('/api/tasks')
            .then(response => response.json())
            .then(tasks => {
                const recentTasksDiv = document.getElementById('recentTasks');
                if (tasks.length === 0) {
                    recentTasksDiv.innerHTML = '<p class="text-gray-500 text-sm">No tasks found</p>';
                    return;
                }

                const recentTasks = tasks.slice(0, 5);
                recentTasksDiv.innerHTML = recentTasks.map(task => `
                    <div class="border rounded-lg p-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium text-gray-900">${task.title}</h4>
                                <p class="text-sm text-gray-600">${task.assignee || 'Unassigned'}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(task.status)}">
                                ${task.status}
                            </span>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
                document.getElementById('recentTasks').innerHTML = '<p class="text-red-500 text-sm">Error loading tasks</p>';
            });
    }

    function loadQuickStats() {
        fetch('/api/tasks')
            .then(response => response.json())
            .then(tasks => {
                const activeTasks = tasks.filter(task => task.status === 'in_progress').length;
                const completedToday = tasks.filter(task => {
                    if (task.status !== 'done') return false;
                    const taskDate = new Date(task.updated_at);
                    const today = new Date();
                    return taskDate.toDateString() === today.toDateString();
                }).length;

                document.getElementById('activeTasksCount').textContent = activeTasks;
                document.getElementById('completedToday').textContent = completedToday;
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
    }

    function scanWorkspace() {
        showLoadingSpinner();
        fetch('/api/workspace/scan', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                hideLoadingSpinner();
                if (data.success) {
                    alert(`Successfully scanned workspace! Created ${data.created_projects.length} projects.`);
                    location.reload();
                } else {
                    // Show user-friendly error message with fallback options
                    const errorMessage = data.fallback_message || data.error || 'Error scanning workspace';
                    const shouldReload = confirm(`${errorMessage}\n\nWould you like to reload the page to see any existing projects?`);
                    if (shouldReload) {
                        location.reload();
                    }
                }
            })
            .catch(error => {
                hideLoadingSpinner();
                console.error('Error:', error);
                const shouldReload = confirm('Network error while scanning workspace.\n\nWould you like to reload the page to see any existing projects?');
                if (shouldReload) {
                    location.reload();
                }
            });
    }

    function getAgentInsights() {
        showLoadingSpinner();
        const context = `Current projects: ${document.querySelectorAll('[data-project]').length} active projects. 
                        Recent activity: ${document.getElementById('activeTasksCount').textContent} active tasks.`;
        
        fetch('/api/agents/insights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ context: context })
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingSpinner();
            if (data.success) {
                displayAgentInsights(data.insights);
            } else {
                alert('Error getting agent insights');
            }
        })
        .catch(error => {
            hideLoadingSpinner();
            console.error('Error:', error);
            alert('Error getting agent insights');
        });
    }

    function createMockData() {
        showLoadingSpinner();
        
        if (!confirm('This will create comprehensive Star Trek-themed mock data including 10 projects, 40-80 tasks, and 3 sprints. Continue?')) {
            hideLoadingSpinner();
            return;
        }
        
        fetch('/api/database/mock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingSpinner();
            if (data.success) {
                alert(`✅ Mock data created successfully!\n\n📊 Created:\n• ${data.created_projects} projects\n• ${data.created_tasks} tasks\n• ${data.created_sprints} sprints\n• ${data.created_activities} crew activities\n\nYour Star Trek-themed Agile Project Manager is now fully populated!`);
                location.reload();
            } else {
                alert('Error creating mock data: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            hideLoadingSpinner();
            console.error('Error:', error);
            alert('Error creating mock data');
        });
    }

    function displayAgentInsights(insights) {
        const insightsDiv = document.getElementById('agentInsights');
        const contentDiv = document.getElementById('insightsContent');
        
        contentDiv.innerHTML = Object.entries(insights).map(([agent, insight]) => `
            <div class="border rounded-lg p-4">
                <h4 class="font-semibold mb-2">${agent.charAt(0).toUpperCase() + agent.slice(1)}</h4>
                <p class="text-gray-700 text-sm">${insight}</p>
            </div>
        `).join('');
        
        insightsDiv.classList.remove('hidden');
    }

    function showCreateProjectModal() {
        document.getElementById('createProjectModal').classList.remove('hidden');
    }

    function hideCreateProjectModal() {
        document.getElementById('createProjectModal').classList.add('hidden');
    }

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentTasks();
        loadDashboardStats();
    });

    function loadRecentTasks() {
        fetch('/api/dashboard/recent-tasks')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRecentTasks(data.tasks);
            } else {
                console.error('Error loading recent tasks:', data.error);
                document.getElementById('recentTasks').innerHTML = '<p class="text-gray-500 text-sm">Error loading tasks</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('recentTasks').innerHTML = '<p class="text-gray-500 text-sm">Error loading tasks</p>';
        });
    }

    function displayRecentTasks(tasks) {
        const recentTasksDiv = document.getElementById('recentTasks');
        
        if (tasks.length === 0) {
            recentTasksDiv.innerHTML = '<p class="text-gray-500 text-sm">No tasks found</p>';
            return;
        }

        const tasksHtml = tasks.map(task => `
            <div class="border rounded-lg p-3 hover:bg-gray-50 transition-colors">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900 text-sm">${task.title}</h4>
                        <p class="text-xs text-gray-600 mt-1">${task.project_name}</p>
                        <div class="flex items-center mt-2 space-x-2">
                            <span class="px-2 py-1 text-xs rounded-full ${getPriorityColorClass(task.priority)}">
                                ${task.priority}
                            </span>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColorClass(task.status)}">
                                ${task.status}
                            </span>
                        </div>
                    </div>
                    ${task.assignee ? `<span class="text-xs text-blue-600">${task.assignee}</span>` : ''}
                </div>
                <div class="mt-2">
                    <a href="/project/${task.project_id}" class="text-blue-600 hover:text-blue-800 text-xs">
                        View Project <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        `).join('');

        recentTasksDiv.innerHTML = tasksHtml;
    }

    function loadDashboardStats() {
        fetch('/api/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboardStats(data.stats);
            } else {
                console.error('Error loading dashboard stats:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function updateDashboardStats(stats) {
        document.getElementById('activeTasksCount').textContent = stats.active_tasks;
        document.getElementById('completedToday').textContent = stats.completed_today;
        
        // Calculate crew efficiency based on completion rate
        const efficiency = stats.total_tasks > 0 ? Math.round((stats.completed_tasks / stats.total_tasks) * 100) : 0;
        document.getElementById('crewEfficiency').textContent = efficiency + '%';
    }

    function getPriorityColorClass(priority) {
        const colors = {
            'low': 'bg-green-100 text-green-800',
            'medium': 'bg-yellow-100 text-yellow-800',
            'high': 'bg-orange-100 text-orange-800',
            'critical': 'bg-red-100 text-red-800'
        };
        return colors[priority] || 'bg-gray-100 text-gray-800';
    }

    function getStatusColorClass(status) {
        const colors = {
            'todo': 'bg-gray-100 text-gray-800',
            'in_progress': 'bg-blue-100 text-blue-800',
            'review': 'bg-purple-100 text-purple-800',
            'done': 'bg-green-100 text-green-800',
            'blocked': 'bg-red-100 text-red-800'
        };
        return colors[status] || 'bg-gray-100 text-gray-800';
    }

    // Handle create project form submission
    document.getElementById('createProjectForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('projectName').value,
            description: document.getElementById('projectDescription').value,
            project_type: document.getElementById('projectType').value,
            tech_stack: [],
            team_members: []
        };

        fetch('/api/projects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Project created successfully!');
                hideCreateProjectModal();
                location.reload();
            } else {
                alert('Error creating project: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating project');
        });
    });
</script>
{% endblock %} 